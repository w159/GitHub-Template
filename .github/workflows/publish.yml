name: Publish to PowerShell Gallery

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  publish:
    name: Publish Module
    runs-on: windows-latest

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version from tag
        id: version
        run: |
          if ($env:GITHUB_REF -match '^refs/tags/v(.+)$') {
            $FullVersion = $Matches[1]
          } else {
            # workflow_dispatch — read from manifest
            $ManifestPath = (Get-ChildItem -Path ./src -Filter '*.psd1').FullName
            $FullVersion = (Import-PowerShellDataFile -Path $ManifestPath).ModuleVersion
          }

          # Split base version and prerelease suffix
          if ($FullVersion -match '^([0-9]+\.[0-9]+\.[0-9]+)-(.+)$') {
            $BaseVersion = $Matches[1]
            $Prerelease  = $Matches[2]
          } else {
            $BaseVersion = $FullVersion
            $Prerelease  = ''
          }

          Write-Host "Full version : $FullVersion"
          Write-Host "Base version : $BaseVersion"
          Write-Host "Prerelease   : $($Prerelease ? $Prerelease : '(none)')"

          "full=$FullVersion"       >> $env:GITHUB_OUTPUT
          "base=$BaseVersion"       >> $env:GITHUB_OUTPUT
          "prerelease=$Prerelease"  >> $env:GITHUB_OUTPUT

      - name: Resolve module name
        id: module
        run: |
          $ModuleName = (Get-ChildItem -Path ./src -Filter '*.psd1').BaseName
          Write-Host "Module: $ModuleName"
          "name=$ModuleName" >> $env:GITHUB_OUTPUT

      - name: Validate tag matches manifest version
        run: |
          $ManifestPath = "./src/${{ steps.module.outputs.name }}.psd1"
          $ManifestVersion = (Import-PowerShellDataFile -Path $ManifestPath).ModuleVersion
          $TagVersion = "${{ steps.version.outputs.base }}"

          if ($TagVersion -ne $ManifestVersion) {
            Write-Error ("Version mismatch — tag says '$TagVersion' but manifest says '$ManifestVersion'. " +
              "Update the ModuleVersion in $ManifestPath to match the tag, then re-tag.")
            exit 1
          }
          Write-Host "Tag ($TagVersion) matches manifest ($ManifestVersion)"

      - name: Display PowerShell version
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"

      - name: Install dependencies
        run: |
          Write-Host "Installing build dependencies..."
          ./Build/build.ps1 -Bootstrap -BootstrapOnly

      - name: Run tests
        run: |
          Write-Host "Running tests before publish..."
          ./Build/build.ps1 -Task Clean, Analyze, Test

      - name: Build module
        run: |
          Write-Host "Building module..."
          ./Build/build.ps1 -Task Build

      - name: Inject prerelease tag into manifest
        if: steps.version.outputs.prerelease != ''
        run: |
          $ModuleName = "${{ steps.module.outputs.name }}"
          $Prerelease = "${{ steps.version.outputs.prerelease }}"
          $ManifestPath = "./Output/$ModuleName/$ModuleName.psd1"
          Write-Host "Injecting Prerelease = '$Prerelease' into $ManifestPath"

          $Content = Get-Content -Path $ManifestPath -Raw
          # Insert Prerelease key into PSData block
          $Content = $Content -replace '(PSData\s*=\s*@\{)', "`$1`n            Prerelease = '$Prerelease'"
          Set-Content -Path $ManifestPath -Value $Content -NoNewline
          Write-Host "Manifest updated for prerelease"

      - name: Publish to PowerShell Gallery
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          $Prerelease = "${{ steps.version.outputs.prerelease }}"
          if ($Prerelease) {
            Write-Host "Publishing as prerelease ($Prerelease)..."
          } else {
            Write-Host "Publishing stable release..."
          }
          ./Build/build.ps1 -Task Publish

      - name: Extract release notes from CHANGELOG
        id: changelog
        run: |
          $Version = "${{ steps.version.outputs.base }}"
          $Content = Get-Content -Path ./CHANGELOG.md -Raw

          # Match the section for this version (up to the next ## heading or end of file)
          $Pattern = "(?ms)^## \[$([regex]::Escape($Version))\][^\r\n]*\r?\n(.+?)(?=^## \[|\z)"
          if ($Content -match $Pattern) {
            $Notes = $Matches[1].Trim()
          } else {
            $Notes = "Release $Version — see [CHANGELOG.md](CHANGELOG.md) for details."
            Write-Warning "Could not find CHANGELOG section for version $Version, using fallback."
          }

          # Write to file for gh release create
          Set-Content -Path release-notes.md -Value $Notes
          Write-Host "--- Release notes ---"
          Write-Host $Notes

      - name: Create ZIP artifact
        id: zip
        run: |
          $ModuleName = "${{ steps.module.outputs.name }}"
          $ZipName = "$ModuleName-v${{ steps.version.outputs.full }}.zip"
          Compress-Archive -Path "./Output/$ModuleName/*" -DestinationPath $ZipName
          Write-Host "Created $ZipName"
          "path=$ZipName" >> $env:GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ModuleName = "${{ steps.module.outputs.name }}"
          $Tag = "v${{ steps.version.outputs.full }}"
          $Title = "$ModuleName $Tag"
          $ZipPath = "${{ steps.zip.outputs.path }}"
          $IsPrerelease = [bool]"${{ steps.version.outputs.prerelease }}"

          $Args = @('release', 'create', $Tag, '--title', $Title, '--notes-file', 'release-notes.md', $ZipPath)
          if ($IsPrerelease) {
            $Args += '--prerelease'
          }

          gh @Args
          Write-Host "GitHub Release created: $Title"
